<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Arti-client WASM Snowflake Example</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        h1 {
            color: #7c3aed;
        }
        #status {
            background: #0f0f23;
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 10px;
        }
        #response {
            background: #0f0f23;
            border: 1px solid #333;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        #response.visible {
            display: block;
        }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #6d28d9;
        }
        .stats {
            color: #22d3ee;
        }
        .expected {
            color: #888;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>Arti-client WASM + Snowflake</h1>
    <p>This example connects to the Tor network via Snowflake bridge and fetches example.com</p>
    <div id="status">Status: Loading WASM module...</div>
    <p>
        <span class="stats"><span id="logCount">0</span> log entries</span> |
        <span class="stats"><span id="readCompleteCount">0</span> Read complete</span>
        <span class="expected">(expected: ~500)</span>
    </p>
    <button id="downloadBtn">Download Logs</button>
    <div id="response"></div>

    <script type="module">
        import init from './wasm_snowflake.js';

        const logs = [];
        let readCompleteCount = 0;
        const statusDiv = document.getElementById('status');
        const logCountSpan = document.getElementById('logCount');
        const readCompleteSpan = document.getElementById('readCompleteCount');
        const downloadBtn = document.getElementById('downloadBtn');
        const responseDiv = document.getElementById('response');

        function addLog(level, msg) {
            // Skip TRACE level logs
            if (level.toUpperCase() === 'TRACE') {
                return;
            }

            const timestamp = new Date().toISOString();
            logs.push(`[${timestamp}] ${level.toUpperCase()}: ${msg}`);
            logCountSpan.textContent = logs.length;

            // Track "Read complete" messages
            if (msg.includes('Read complete')) {
                readCompleteCount++;
                readCompleteSpan.textContent = readCompleteCount;
            }
        }

        function showResponse(text) {
            responseDiv.textContent = text;
            responseDiv.classList.add('visible');
        }

        // Override console to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const originalDebug = console.debug;

        console.log = (...args) => {
            addLog('info', args.join(' '));
            originalLog.apply(console, args);
        };
        console.warn = (...args) => {
            addLog('warn', args.join(' '));
            originalWarn.apply(console, args);
        };
        console.error = (...args) => {
            addLog('error', args.join(' '));
            originalError.apply(console, args);
        };
        console.debug = (...args) => {
            addLog('debug', args.join(' '));
            originalDebug.apply(console, args);
        };

        // Expose showResponse for WASM to call
        window.showResponse = showResponse;

        downloadBtn.addEventListener('click', () => {
            const content = logs.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webtor-logs-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        async function run() {
            try {
                statusDiv.textContent = 'Status: Initializing WASM module...';
                addLog('info', 'Initializing WASM module...');
                await init();
                statusDiv.textContent = 'Status: WASM initialized, bootstrapping Tor...';
                addLog('info', 'WASM module initialized.');
            } catch (e) {
                statusDiv.textContent = `Status: Error - ${e}`;
                addLog('error', `Failed to initialize: ${e}`);
                console.error(e);
            }
        }

        run();
    </script>
</body>
</html>