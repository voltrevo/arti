<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Arti-client WASM Snowflake Example</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        h1 {
            color: #7c3aed;
        }
        #status {
            background: #0f0f23;
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 10px;
        }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #6d28d9;
        }
        #logCount {
            color: #22d3ee;
        }
    </style>
</head>
<body>
    <h1>Arti-client WASM + Snowflake</h1>
    <p>This example connects to the Tor network via Snowflake bridge and fetches example.com</p>
    <div id="status">Status: Loading WASM module...</div>
    <p><span id="logCount">0</span> log entries captured</p>
    <button id="downloadBtn">Download Logs</button>

    <script type="module">
        import init from './wasm_snowflake.js';

        const logs = [];
        const statusDiv = document.getElementById('status');
        const logCountSpan = document.getElementById('logCount');
        const downloadBtn = document.getElementById('downloadBtn');

        function addLog(level, msg) {
            const timestamp = new Date().toISOString();
            logs.push(`[${timestamp}] ${level.toUpperCase()}: ${msg}`);
            logCountSpan.textContent = logs.length;
        }

        // Override console to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = (...args) => {
            addLog('info', args.join(' '));
            originalLog.apply(console, args);
        };
        console.warn = (...args) => {
            addLog('warn', args.join(' '));
            originalWarn.apply(console, args);
        };
        console.error = (...args) => {
            addLog('error', args.join(' '));
            originalError.apply(console, args);
        };

        downloadBtn.addEventListener('click', () => {
            const content = logs.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webtor-logs-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        async function run() {
            try {
                statusDiv.textContent = 'Status: Initializing WASM module...';
                addLog('info', 'Initializing WASM module...');
                await init();
                statusDiv.textContent = 'Status: WASM initialized, bootstrapping Tor...';
                addLog('info', 'WASM module initialized.');
            } catch (e) {
                statusDiv.textContent = `Status: Error - ${e}`;
                addLog('error', `Failed to initialize: ${e}`);
                console.error(e);
            }
        }

        run();
    </script>
</body>
</html>