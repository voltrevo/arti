name: Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run cargo tests
      run: cargo test --workspace

    - name: Run subtle-tls tests with TLS 1.2
      run: cargo test -p subtle-tls --features tls12

    - name: Check WASM build (webtor)
      run: cargo check --package webtor --target wasm32-unknown-unknown

    - name: Check WASM build (subtle-tls)
      run: cargo check --package subtle-tls --target wasm32-unknown-unknown --features tls12

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: rust-tests

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown

    - name: Install wasm-pack
      run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install npm dependencies
      run: npm install

    - name: Install Playwright
      run: npx playwright install chromium

    - name: Build WASM demo
      run: wasm-pack build webtor-demo --target web --release

    - name: Run TLS connection tests
      run: npm run test:tls
      timeout-minutes: 10

  clippy:
    name: Clippy
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy
        targets: wasm32-unknown-unknown

    - name: Run clippy
      run: cargo clippy --workspace --all-targets -- -D warnings
      continue-on-error: true

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt

    - name: Check formatting
      run: cargo fmt --all -- --check
      continue-on-error: true
